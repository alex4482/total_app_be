# Backend API - Ghid Complet de Integrare Frontend

Acest document oferƒÉ o vedere de ansamblu asupra tuturor API-urilor disponibile √Æn aplica»õia backend »ôi cum sƒÉ le folose»ôti din frontend.

## üìã Cuprins

1. [Authentication API](./01-authentication.md) - Autentificare »ôi gestionare tokene JWT
2. [Tenants API](./02-tenants.md) - Gestionare chiria»ôi (CRUD, import Excel, bulk operations)
3. [Buildings API](./03-buildings.md) - Gestionare clƒÉdiri »ôi spa»õii de √Ænchiriat
4. [Files API](./04-files.md) - Upload, download, »ôi gestionare fi»ôiere
5. [Email Presets API](./05-email-presets.md) - »òabloane email »ôi trimitere email-uri
6. [Index Counters API](./06-index-counters.md) - Gestionare contoare »ôi citiri

---

## üîó Base URL

**Development:** `http://localhost:8080`  
**Production:** `https://api.donix.ro`

---

## üîê Autentificare

Toate request-urile (cu excep»õia `/auth/login` »ôi `/auth/refresh-token`) necesitƒÉ un token JWT valid √Æn header:

```http
Authorization: Bearer {accessToken}
```

### Workflow autentificare:

```typescript
// 1. Login
const loginResponse = await fetch('/auth/login', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ username: 'user', password: 'pass' })
});
const { tokens } = await loginResponse.json();

// 2. SalveazƒÉ token-urile
localStorage.setItem('accessToken', tokens.accessToken);
localStorage.setItem('refreshToken', tokens.refreshToken);

// 3. Folose»ôte access token √Æn toate request-urile
const response = await fetch('/tenants', {
  headers: { 
    'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
  }
});

// 4. DacƒÉ prime»ôti 401, refresh token-ul
if (response.status === 401) {
  const refreshResponse = await fetch('/auth/refresh-token', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ 
      refreshToken: localStorage.getItem('refreshToken') 
    })
  });
  const { tokens: newTokens } = await refreshResponse.json();
  localStorage.setItem('accessToken', newTokens.accessToken);
  localStorage.setItem('refreshToken', newTokens.refreshToken);
  // Retry request-ul original
}
```

---

## üìÅ Workflow-uri Principale

### 1. Gestionare Chiria»ôi

#### Creare chiria»ôi simplu:
```typescript
const tenant = await fetch('/tenants', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${token}`
  },
  body: JSON.stringify({
    name: "Tenant SRL",
    cui: "RO12345678",
    regNumber: "J40/1234/2023",
    active: true,
    emails: ["contact@tenant.com"],
    phoneNumbers: ["0712345678"]
  })
});
```

#### Import chiria»ôi din Excel:
```typescript
const formData = new FormData();
formData.append('file', excelFile);

const result = await fetch('/tenants/import', {
  method: 'POST',
  headers: { 'Authorization': `Bearer ${token}` },
  body: formData
});

const { savedCount, skippedCount, skippedNames } = await result.json();
console.log(`Salva»õi: ${savedCount}, Omisi: ${skippedCount}`);
```

#### »òtergere multiplƒÉ:
```typescript
const result = await fetch('/tenants/bulk-delete', {
  method: 'DELETE',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${token}`
  },
  body: JSON.stringify([1, 2, 3, 4, 5]) // IDs
});

const { deletedCount, failedTenants } = await result.json();
```

---

### 2. Gestionare Fi»ôiere

#### Upload fi»ôiere (2 pa»ôi):

```typescript
// PASUL 1: Upload temporar
const formData = new FormData();
files.forEach(file => formData.append('files', file));

const tempResponse = await fetch('/files/temp', {
  method: 'POST',
  headers: { 'Authorization': `Bearer ${token}` },
  body: formData
});
const tempFiles = await tempResponse.json();
// tempFiles = [{ tempId: "uuid-1", filename: "doc.pdf", ... }]

// PASUL 2: Commit la owner (ex: tenant cu id=5)
const tempIds = tempFiles.map(f => f.tempId).join('&tempIds=');
const commitResponse = await fetch(
  `/files/commit?ownerType=TENANT&ownerId=5&tempIds=${tempIds}`,
  {
    method: 'POST',
    headers: { 'Authorization': `Bearer ${token}` }
  }
);
const permanentFiles = await commitResponse.json();
```

#### Download fi»ôier:
```typescript
window.open(`/files/${fileId}`, '_blank');
```

#### Download multiple fi»ôiere ca ZIP:
```typescript
const fileIds = ['uuid1', 'uuid2', 'uuid3'];
const url = `/files/download-zip?${fileIds.map(id => `fileIds=${id}`).join('&')}`;
window.open(url, '_blank');
```

#### »òtergere fi»ôier:
```typescript
await fetch(`/files/${fileId}`, {
  method: 'DELETE',
  headers: { 'Authorization': `Bearer ${token}` }
});
```

---

### 3. Trimitere Email-uri

#### Cu ata»ôamente din temp upload:

```typescript
// 1. Upload fi»ôiere √Æn temp
const formData = new FormData();
attachments.forEach(file => formData.append('files', file));

const tempResponse = await fetch('/files/temp', {
  method: 'POST',
  headers: { 'Authorization': `Bearer ${token}` },
  body: formData
});
const tempFiles = await tempResponse.json();

// 2. Trimite emailul
const emailData = {
  data: [{
    subject: "Factura Luna Ianuarie",
    message: "BunƒÉ ziua,\n\nVƒÉ trimitem factura...",
    attachedFilesIds: tempFiles.map(f => f.tempId),
    recipients: ["client@example.com", "alt@example.com"]
  }]
};

const sendResponse = await fetch('/email-presets/send-emails', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${token}`
  },
  body: JSON.stringify(emailData)
});

const failedEmails = await sendResponse.json();
if (failedEmails.length === 0) {
  console.log('Toate email-urile au fost trimise cu succes!');
} else {
  failedEmails.forEach(email => {
    console.error(`Failed: ${email.errorMessage}`);
  });
}
```

---

## üîß Tipuri »ôi EnumerƒÉri Comune

### OwnerType (pentru fi»ôiere)
```typescript
type OwnerType = 
  | "TENANT"
  | "BUILDING"
  | "ROOM"
  | "RENTAL_SPACE"
  | "EMAIL_DATA"
  | "BUILDING_LOCATION"
  | "FIRM"
  | "CAR"
  | "OTHER";
```

### BuildingLocation
```typescript
type BuildingLocation = 
  | "LETCANI"
  | "TOMESTI";
```

### CounterType
```typescript
type CounterType = 
  | "WATER"
  | "GAS"
  | "ELECTRICITY";
```

---

## ‚ö†Ô∏è Lucruri Importante de »òtiut

### 1. Fi»ôiere
- **Temp upload ‚Üí Commit workflow:** Fi»ôierele TREBUIE mai √Ænt√¢i uploadate √Æn `/files/temp`, apoi committed la un owner
- **Auto-delete:** C√¢nd »ôtergi un tenant/building, fi»ôierele sale sunt »ôterse AUTOMAT
- **Temp files:** Fi»ôierele temporare NU sunt »ôterse automat - gestioneazƒÉ-le manual
- **ZIP download:** Este GET (nu POST), po»õi deschide direct √Æn browser cu `window.open()`

### 2. Tenants
- **Active default:** C√¢nd creezi un tenant nou fƒÉrƒÉ sƒÉ specifici `active`, va fi `false` by default
- **Import Excel:** DacƒÉ existƒÉ deja un tenant cu acela»ôi nume ‚Üí UPDATE, altfel CREATE
- **Bulk delete:** Prime»ôti √Ænapoi lista tenants care NU au putut fi »ôter»ôi (cu motivul)

### 3. Email
- **Ata»ôamente:** Folose»ôte ID-urile TEMPORARE (din `/files/temp`), nu cele permanente
- **Validare:** Backend-ul valideazƒÉ format email, subject obligatoriu, message obligatoriu
- **Response:** Prime»ôti √Ænapoi DOAR email-urile care au E»òUAT

### 4. Email Presets
- **Update by name:** C√¢nd salvezi un preset cu un `name` care existƒÉ deja ‚Üí face UPDATE automat
- **Bulk save:** `POST /email-presets/bulk` »òTERGE toate preset-urile existente!

---

## üö® Gestionare Erori

### Status Codes Comune:
- `200 OK` - Success
- `201 Created` - Resursa a fost creatƒÉ
- `204 No Content` - Success, fƒÉrƒÉ con»õinut de returnat
- `400 Bad Request` - Date invalide √Æn request
- `401 Unauthorized` - Token lipsƒÉ sau invalid (refresh token!)
- `403 Forbidden` - Acces interzis
- `404 Not Found` - Resursa nu existƒÉ
- `409 Conflict` - Conflict (ex: fi»ôier duplicat, tenant cu dependin»õe)
- `500 Internal Server Error` - Eroare server

### Pattern de Gestionare:

```typescript
async function apiCall(url: string, options: RequestInit) {
  const response = await fetch(url, {
    ...options,
    headers: {
      ...options.headers,
      'Authorization': `Bearer ${getAccessToken()}`
    }
  });

  if (response.status === 401) {
    // Token expirat, √ÆncearcƒÉ refresh
    await refreshAccessToken();
    // Retry request
    return apiCall(url, options);
  }

  if (!response.ok) {
    const errorText = await response.text();
    throw new Error(`API Error ${response.status}: ${errorText}`);
  }

  // 204 No Content nu are body
  if (response.status === 204) {
    return null;
  }

  return response.json();
}
```

---

## üìù Exemple Complete

### Exemplu: Creare tenant cu fi»ôiere

```typescript
async function createTenantWithFiles(
  tenantData: CreateTenantDto,
  files: File[]
) {
  // 1. CreeazƒÉ tenant
  const tenant = await fetch('/tenants', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${token}`
    },
    body: JSON.stringify(tenantData)
  }).then(r => r.json());

  // 2. Upload fi»ôiere temporar
  const formData = new FormData();
  files.forEach(file => formData.append('files', file));
  
  const tempFiles = await fetch('/files/temp', {
    method: 'POST',
    headers: { 'Authorization': `Bearer ${token}` },
    body: formData
  }).then(r => r.json());

  // 3. Commit fi»ôiere la tenant
  const tempIds = tempFiles.map(f => f.tempId).join('&tempIds=');
  const permanentFiles = await fetch(
    `/files/commit?ownerType=TENANT&ownerId=${tenant.id}&tempIds=${tempIds}`,
    {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${token}` }
    }
  ).then(r => r.json());

  return { tenant, files: permanentFiles };
}
```

### Exemplu: Trimitere email cu preset

```typescript
async function sendEmailFromPreset(
  presetId: number,
  recipients: string[],
  attachments: File[]
) {
  // 1. Ob»õine preset
  const { presets } = await fetch('/email-presets', {
    headers: { 'Authorization': `Bearer ${token}` }
  }).then(r => r.json());
  
  const preset = presets.find(p => p.id === presetId);

  // 2. Upload ata»ôamente √Æn temp
  const formData = new FormData();
  attachments.forEach(file => formData.append('files', file));
  
  const tempFiles = await fetch('/files/temp', {
    method: 'POST',
    headers: { 'Authorization': `Bearer ${token}` },
    body: formData
  }).then(r => r.json());

  // 3. Trimite email
  const failedEmails = await fetch('/email-presets/send-emails', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${token}`
    },
    body: JSON.stringify({
      data: [{
        subject: preset.subject,
        message: preset.message,
        attachedFilesIds: tempFiles.map(f => f.tempId),
        recipients: recipients
      }]
    })
  }).then(r => r.json());

  return {
    success: failedEmails.length === 0,
    failed: failedEmails
  };
}
```

---

## üìö Resurse Adi»õionale

Pentru detalii complete despre fiecare endpoint, consultƒÉ fi»ôierele individuale:

- **[01-authentication.md](./01-authentication.md)** - Login, refresh token
- **[02-tenants.md](./02-tenants.md)** - CRUD tenants, import Excel, bulk delete
- **[03-buildings.md](./03-buildings.md)** - Buildings, rental spaces
- **[04-files.md](./04-files.md)** - Upload, download, ZIP, delete files
- **[05-email-presets.md](./05-email-presets.md)** - Email templates »ôi trimitere
- **[06-index-counters.md](./06-index-counters.md)** - Contoare »ôi citiri

---

## üîÑ Versioning

**Current API Version:** v1  
**Last Updated:** Octombrie 2024

Pentru probleme sau √ÆntrebƒÉri despre API, contacteazƒÉ echipa de backend.

